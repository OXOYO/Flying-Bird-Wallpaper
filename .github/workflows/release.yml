name: Build and Release

on:
  push:
    tags:
      - 'v*' # å½“æ¨é€ä»¥vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œä¾‹å¦‚v1.0.0

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.id }}
      upload_url: ${{ steps.create-release.outputs.upload_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºç”Ÿæˆchangelog

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Generate Changelog
        id: changelog
        run: |
          # è·å–æœ€æ–°çš„ä¸¤ä¸ªæ ‡ç­¾
          LATEST_TAG=$(git describe --tags --abbrev=0)
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 `git rev-list --tags --skip=1 --max-count=1`)

          # å¦‚æœæ²¡æœ‰å‰ä¸€ä¸ªæ ‡ç­¾ï¼Œåˆ™ä»ç¬¬ä¸€æ¬¡æäº¤å¼€å§‹
          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi

          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          echo "## What's Changed" >> CHANGELOG.md
          echo "" >> CHANGELOG.md

          # æ–°ç‰¹æ€§
          FEATURES=$(git log $PREVIOUS_TAG..$LATEST_TAG --pretty=format:"* %s" --reverse | grep -i -E "feat:|feature:|æ–°å¢|æ·»åŠ " | sed 's/^* feat: /* /' | sed 's/^* feature: /* /')
          if [ ! -z "$FEATURES" ]; then
            echo "### New Features ğŸ‰" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "$FEATURES" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Bug ä¿®å¤
          FIXES=$(git log $PREVIOUS_TAG..$LATEST_TAG --pretty=format:"* %s" --reverse | grep -i -E "fix:|ä¿®å¤|bug|é—®é¢˜" | sed 's/^* fix: /* /')
          if [ ! -z "$FIXES" ]; then
            echo "### Bug Fixes ğŸ" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "$FIXES" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # æ–‡æ¡£
          DOCS=$(git log $PREVIOUS_TAG..$LATEST_TAG --pretty=format:"* %s" --reverse | grep -i -E "docs:|doc:|æ–‡æ¡£" | sed 's/^* docs: /* /' | sed 's/^* doc: /* /')
          if [ ! -z "$DOCS" ]; then
            echo "### Document ğŸ“–" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "$DOCS" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # å…¶ä»–å˜æ›´
          OTHERS=$(git log $PREVIOUS_TAG..$LATEST_TAG --pretty=format:"* %s" --reverse | grep -v -i -E "feat:|feature:|fix:|docs:|doc:|chore:|merge|æ–°å¢|æ·»åŠ |ä¿®å¤|bug|é—®é¢˜|æ–‡æ¡£|æ‚åŠ¡" | grep -v "^$")
          if [ ! -z "$OTHERS" ]; then
            echo "### Other Changes" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "$OTHERS" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # å°†å˜æ›´æ—¥å¿—å†…å®¹è®¾ç½®ä¸ºè¾“å‡ºå˜é‡
          CHANGELOG=$(cat CHANGELOG.md)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create-release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false

  build:
    needs: create-release
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
        include:
          - os: macos-latest
            build_command: npm run build:mac
          - os: windows-latest
            build_command: npm run build:win

    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Uninstall sharp
        run: npm uninstall sharp

      - name: Install sharp with optional dependencies
        run: npm install --include=optional sharp

      - name: Install sharp for macOS
        if: matrix.os == 'macos-latest'
        run: npm install --os=darwin --cpu=x64 sharp

      - name: Install sharp for Windows
        if: matrix.os == 'windows-latest'
        run: npm install --os=win32 sharp

      - name: Build application
        run: ${{ matrix.build_command }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ·»åŠ è¿™ä¸ªæ–°æ­¥éª¤ï¼Œåœ¨ä¸Šä¼ å‰åˆ é™¤ .blockmap æ–‡ä»¶
      - name: Check blockmap files (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          echo "æ£€æŸ¥ .blockmap æ–‡ä»¶æ•°é‡ï¼š"
          find dist -name "*.blockmap" | wc -l

      - name: Remove blockmap files (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          find dist -name "*.blockmap" -type f -delete
          echo "å·²åˆ é™¤æ‰€æœ‰ .blockmap æ–‡ä»¶"

      - name: Check blockmap files (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          $count = (Get-ChildItem -Path dist -Filter "*.blockmap" -Recurse).Count
          echo "è¿˜æœ‰ $count ä¸ª .blockmap æ–‡ä»¶"

      - name: Remove blockmap files (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          Get-ChildItem -Path dist -Filter "*.blockmap" -Recurse | Remove-Item -Force
          echo "å·²åˆ é™¤æ‰€æœ‰ .blockmap æ–‡ä»¶"

      # æ·»åŠ éªŒè¯æ­¥éª¤
      - name: Verify deletion (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          remaining=$(find dist -name "*.blockmap" | wc -l)
          echo "åˆ é™¤åå‰©ä½™ .blockmap æ–‡ä»¶æ•°é‡ï¼š$remaining"
          if [ "$remaining" -gt 0 ]; then
            echo "è­¦å‘Šï¼šä»æœ‰ .blockmap æ–‡ä»¶æœªè¢«åˆ é™¤"
            find dist -name "*.blockmap"
          fi

      - name: Verify deletion (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          $remaining = (Get-ChildItem -Path dist -Filter "*.blockmap" -Recurse).Count
          echo "åˆ é™¤åå‰©ä½™ .blockmap æ–‡ä»¶æ•°é‡ï¼š$remaining"
          if ($remaining -gt 0) {
            echo "è­¦å‘Šï¼šä»æœ‰ .blockmap æ–‡ä»¶æœªè¢«åˆ é™¤"
            Get-ChildItem -Path dist -Filter "*.blockmap" -Recurse | ForEach-Object { echo $_.FullName }
          }

      # æ·»åŠ å¼ºåˆ¶åˆ é™¤æ­¥éª¤ï¼Œç¡®ä¿æ‰€æœ‰ .blockmap æ–‡ä»¶éƒ½è¢«åˆ é™¤
      - name: Force remove blockmap files (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          rm -f dist/*.blockmap
          rm -f dist/**/*.blockmap
          echo "å·²å¼ºåˆ¶åˆ é™¤æ‰€æœ‰ .blockmap æ–‡ä»¶"

      - name: Force remove blockmap files (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          if (Test-Path dist/*.blockmap) { Remove-Item -Path dist/*.blockmap -Force }
          Get-ChildItem -Path dist -Recurse -Filter "*.blockmap" | Remove-Item -Force
          echo "å·²å¼ºåˆ¶åˆ é™¤æ‰€æœ‰ .blockmap æ–‡ä»¶"

      # ä¿®æ”¹è¿™ä¸ªæ­¥éª¤ï¼Œä¸ºä¸åŒæ“ä½œç³»ç»Ÿä½¿ç”¨ä¸åŒçš„å‘½ä»¤
      - name: List files before upload (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          echo "ä¸Šä¼ å‰æ£€æŸ¥æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -la dist/

      - name: List files before upload (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          echo "ä¸Šä¼ å‰æ£€æŸ¥æ–‡ä»¶åˆ—è¡¨ï¼š"
          Get-ChildItem -Path dist/ -Force

      - name: Upload artifacts to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.exe
            dist/*.dmg
            dist/latest*.yml
            !dist/builder-debug.yml
            !dist/**/*.blockmap
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ·»åŠ æ–°æ­¥éª¤ï¼Œä½¿ç”¨ GitHub API åˆ é™¤ .blockmap æ–‡ä»¶
      - name: Delete blockmap assets from release
        if: matrix.os == 'macos-latest' # åªåœ¨ä¸€ä¸ªä½œä¸šä¸­æ‰§è¡Œï¼Œé¿å…å†²çª
        run: |
          TOKEN="${{ secrets.GITHUB_TOKEN }}"
          REPO="${{ github.repository }}"
          TAG="${{ github.ref_name }}"

          echo "å¼€å§‹æ¸…ç† GitHub Release ä¸­çš„ .blockmap æ–‡ä»¶..."

          # å®‰è£… jq ç”¨äºè§£æ JSON
          if [ "$(uname)" == "Darwin" ]; then
            brew install jq
          elif [ "$(expr substr $(uname -s) 1 5)" == "Linux" ]; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          # è·å– Release ID
          echo "è·å– Release ID..."
          RELEASE_ID=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$REPO/releases/tags/$TAG" | \
            jq -r '.id')

          if [ "$RELEASE_ID" == "null" ]; then
            echo "æ— æ³•è·å– Release IDï¼Œå¯èƒ½æ˜¯ Release å°šæœªåˆ›å»ºæˆ–æƒé™ä¸è¶³"
            exit 0
          fi

          echo "æ‰¾åˆ° Release ID: $RELEASE_ID"

          # è·å–æ‰€æœ‰èµ„äº§
          echo "è·å–æ‰€æœ‰èµ„äº§..."
          ASSETS=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$REPO/releases/$RELEASE_ID/assets")

          # åˆ é™¤ blockmap æ–‡ä»¶
          echo "æŸ¥æ‰¾å¹¶åˆ é™¤ .blockmap æ–‡ä»¶..."
          echo "$ASSETS" | jq -r '.[] | select(.name | endswith(".blockmap")) | .id' | \
          while read asset_id; do
            if [ -n "$asset_id" ]; then
              echo "åˆ é™¤èµ„äº§ ID: $asset_id"
              curl -X DELETE -H "Authorization: token $TOKEN" \
                "https://api.github.com/repos/$REPO/releases/assets/$asset_id"
              echo "å·²åˆ é™¤ä¸€ä¸ª .blockmap æ–‡ä»¶"
            fi
          done

          echo "æ¸…ç†å®Œæˆ"
